document.addEventListener("DOMContentLoaded",()=>{const e="https://auth.tidyzenic.com",t=document.getElementById("registerForm"),n=document.getElementById("submitBtn"),a={businessName:document.getElementById("business_name"),email:document.getElementById("email"),phone:document.getElementById("phone"),countryCode:document.getElementById("country_code"),subdomain:document.getElementById("subdomain"),password:document.getElementById("password"),confirmPassword:document.getElementById("confirmPassword"),ownerName:document.getElementById("owner_name"),location:document.getElementById("location"),vatNumber:document.getElementById("vat_number"),terms:document.getElementById("terms")},o={businessName:document.getElementById("business-name-feedback"),email:document.getElementById("email-feedback"),phone:document.getElementById("phone-feedback"),ownerName:document.getElementById("owner-name-feedback"),location:document.getElementById("location-feedback"),subdomain:document.getElementById("subdomain-feedback"),password:document.getElementById("password-feedback"),confirmPassword:document.getElementById("confirm-password-feedback"),terms:document.getElementById("terms-feedback")},s=document.getElementById("subPreview"),m=document.getElementById("email-login-hint");function r(e,t,n=!1){o[e]&&(o[e].textContent=t,o[e].className=(n?"text-green-600":"text-red-600")+" text-sm")}let d;a.email.addEventListener("input",()=>{const e=/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(a.email.value.trim());r("email",e?"✅ Valid email.":"❌ Invalid email format.",e),m.innerHTML=""}),a.businessName.addEventListener("input",()=>{const t=a.businessName.value.trim().toLowerCase().replace(/\s+/g,"-");var n;a.subdomain.value=t,s.textContent=`${t}.tidyzenic.com`,n=t,clearTimeout(d),d=setTimeout(()=>async function(t){if(t)try{const n=await fetch(`${e}/register/check-subdomain`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({subdomain:t})}),a=await n.json();r("subdomain",a.exists?"❌ Subdomain is already taken.":"✅ Subdomain is available.",!a.exists)}catch{r("subdomain","❌ Unable to check subdomain availability.")}}(n),500)}),a.confirmPassword.addEventListener("input",()=>{const e=a.password.value===a.confirmPassword.value;r("confirmPassword",e?"✅ Passwords match.":"❌ Passwords do not match.",e)}),t.addEventListener("submit",async d=>{d.preventDefault(),Object.values(o).forEach(e=>e.textContent=""),m&&(m.innerHTML="");let i=!1;if(/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(a.email.value.trim())||(r("email","❌ Invalid email."),i=!0),a.password.value!==a.confirmPassword.value&&(r("confirmPassword","❌ Passwords do not match."),i=!0),a.terms.checked||(r("terms","❌ You must agree to the terms."),i=!0),i)return;const l={businessName:a.businessName.value.trim(),email:a.email.value.trim(),phone:`${a.countryCode.value}${a.phone.value.trim()}`,subdomain:a.subdomain.value.trim(),password:a.password.value,location:a.location.value.trim(),ownerName:a.ownerName.value.trim(),vatNumber:a.vatNumber.value.trim()};n.disabled=!0;try{const n=await fetch(`${e}/register`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(l)}),a=await n.json();n.ok?(alert(a.message||"✅ Registered successfully!"),t.reset(),s.textContent="__.tidyzenic.com",m.innerHTML="",window.location.href="/login.html"):a.error?.toLowerCase().includes("email")?(r("email",a.error),m.innerHTML='<a href="/login.html" class="text-blue-600 underline">Already registered? Login here →</a>'):a.error?.toLowerCase().includes("subdomain")?r("subdomain",a.error):alert(a.error||"❌ Something went wrong.")}catch(e){console.error("❌ Error:",e),alert("❌ Server error. Try again later.")}finally{n.disabled=!1}})});